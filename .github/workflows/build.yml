name: Build and deploy

on:
  push:
    branches:
      - main

jobs:
  build-android:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v2

     - name: Set up nodejs
       uses: actions/setup-node@v2
       with:
         node-version: '18'

     - name: Set up JDK
       uses: actions/setup-java@v3
       with:
         distribution: 'temurin'
         java-version: '17'  

     - name: Install dependencies
       run: npm install

     - name: Android prebuild
       run: npx expo prebuild --platform android
    
     - name: Build android
       run: |
         cd android
         ./gradlew assembleRelease

     - name: Upload apk
       uses: actions/upload-artifact@v2
       with:
         name: android-apk
         path: android/app/build/outputs/apk/release/app-release.apk

     - name: Upload APK to Google Play
       uses: r0adkll/upload-google-play@v1
       with:
        serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        packageName: ${{ secrets.PACKAGE_NAME }}
        releaseFiles: android/app/build/outputs/apk/release/app-release.apk
        track: internal

  build-ios:
   runs-on: macos-latest
   steps:
     - uses: actions/checkout@v2

     - name: Set up nodejs
       uses: actions/setup-node@v2
       with:
         node-version: '18'

     - name: Install dependencies
       run: npm install

     - name: iOS prebuild
       run: npx expo prebuild --platform ios
    
     - name: Install CocoaPods
       run: |
         cd ios
         pod install
       
     - name: Build iOS 
       run: |
         cd ios
         xcodebuild -workspace test.xcworkspace -scheme test -configuration Release -sdk iphoneos -allowProvisioningUpdates archive -archivePath $PWD/build/test.xcarchive
         xcodebuild -exportArchive -archivePath $PWD/build/test.xcarchive -exportOptionsPlist $PWD/build/exportOptions.plist -exportPath $PWD/build

     - name: Upload IPA
       uses: actions/upload-artifact@v2
       with:
         name: ios-ipa
         path: release/ios/*.ipa
       
